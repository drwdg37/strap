<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Strap Sorting Log</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#fdf6e3" />

  <style>
    :root {
      /* Light theme */
      --bg: #fdf6e3;           /* cream */
      --panel: #ffffff;        /* cards/inputs */
      --muted: #4b5563;        /* secondary text */
      --text: #000000;         /* primary text */
      /* Keep action/selection highlight colors exactly like the skirting app */
      --accent: #22d3ee;
      --accent-2: #a78bfa;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 18px;
      --danger: #ef4444;
      --border-1: rgba(0,0,0,.15);
      --border-2: rgba(0,0,0,.30);
      --border-3: rgba(0,0,0,.40);
      --table: rgba(0,0,0,.10);
      --hover: rgba(0,0,0,.03);
      --input-bg: #ffffff;
      --chip-bg: #ffffff;
    }
    html, body { height: 100%; }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #fefcf8, var(--bg) 40%);
      color: var(--text);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: clamp(16px, 3vw, 28px); }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 14px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width: 40px; height: 40px; border-radius: 10px;
      /* keep a visible accent but neutral shape; actual installed icon comes from manifest */
      background: radial-gradient(circle at 30% 30%, #22d3ee, #1d4ed8);
      box-shadow: var(--shadow);
    }
    h1 { font-size: clamp(20px, 5vw, 28px); margin:0; letter-spacing:.3px; }

    .card {
      position: relative; z-index: 0;
      background: var(--panel);
      border: 1px solid var(--border-1);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(14px, 3vw, 22px);
    }

    /* Responsive top row */
    .grid-3 {
      display:grid;
      grid-template-columns: 150px minmax(160px, 1fr) 220px;
      gap: 16px;
    }
    .grid-3 > div { min-width: 0; }
    @media (max-width: 900px){
      .grid-3 { grid-template-columns: 1fr 1fr; }
      .grid-3 > div:nth-child(3){ grid-column: span 2; } /* Lot moves to its own row */
    }
    @media (max-width: 600px){
      .grid-3 { grid-template-columns: 1fr; }
      .grid-3 > div:nth-child(3){ grid-column: auto; }
    }

    label { display:block; font-weight: 700; color: #111827; margin-bottom: 6px; }
    input[type="text"], select {
      width: 100%; padding: 14px 12px; border-radius: 12px;
      border: 1px solid var(--border-2);
      background: var(--input-bg); color: var(--text); outline: none;
    }
    input::placeholder { color: #6b7280; }

    .row { display:flex; gap: 12px; align-items:center; flex-wrap: wrap; }
    .btn { appearance:none; border:0; padding: 14px 18px; border-radius: 12px; font-weight:700;
      letter-spacing:.3px; color:#0b1020; background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow); cursor:pointer; }
    .btn.secondary {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border-2);
    }
    .btn.danger { background: linear-gradient(135deg, #f87171, var(--danger)); color:#0b1020; }
    .btn:active { transform: translateY(1px); }

    .section-title { font-weight:800; letter-spacing:.6px; margin:2px 0 10px; text-transform:uppercase; font-size:14px; color:#111827; }

    .choices { position: relative; z-index: 1; display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; pointer-events:auto; }
    .choices.smallCols { grid-template-columns: repeat(2, minmax(0,1fr)); }

    .chip { position: relative; z-index: 2; user-select:none; -webkit-user-select:none; padding: 16px 10px; border-radius: 14px;
      border: 2px solid var(--border-3); background: var(--chip-bg); color: var(--text); cursor:pointer; font-weight:800;
      text-align:center; box-shadow: var(--shadow); line-height:1.1; pointer-events:auto; touch-action: manipulation; }
    .chip .top { display:block; font-size:14px; opacity:.9; pointer-events:none; }
    .chip .bottom { display:block; font-size:18px; margin-top:2px; opacity:.95; pointer-events:none; }
    .chip.single { padding: 16px; font-size:16px; }

    /* Keep SAME selected styles from dark app so users recognize them */
    .chip.sel-selected { background: linear-gradient(135deg, rgba(34,211,238,.18), rgba(167,139,250,.18)); border-color: rgba(34,211,238,.8); }
    .chip.reason-selected { background: linear-gradient(135deg, rgba(239,68,68,.22), rgba(239,68,68,.10)); border-color: rgba(239,68,68,.85); }

    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--table); text-align:left; font-size: 15px; color: var(--text); }
    th { color:#111827; font-weight:800; }
    tbody tr:hover { background: var(--hover); }

    .hint { color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Strap Sorting Log</h1>
      </div>
      <div class="row">
        <button id="exportBtn" class="btn secondary" title="Download CSV of all entries">Export CSV</button>
      </div>
    </header>

    <section class="card">
      <div class="grid-3" style="margin-bottom:12px">
        <div>
          <label for="packer">Packer</label>
          <select id="packer">
            <option value="" hidden>Select</option>
            <option>PHA</option>
            <option>Tyson</option>
            <option>TexPac</option>
            <option>Mixed</option>
          </select>
        </div>
        <div>
          <label for="sortedBy">Sorted By</label>
          <input id="sortedBy" type="text" placeholder="Name" />
        </div>
        <div>
          <label for="lot">Lot Number</label>
          <!-- Favors numbers but allows letters; max 6 chars -->
          <input id="lot" type="text" maxlength="6" placeholder="e.g., 105 or 105CS" inputmode="numeric" pattern="[0-9A-Za-z]*" />
        </div>
      </div>

      <div class="row" style="gap:24px">
        <div style="flex:1">
          <div class="section-title">Selection</div>
          <div id="selectionChoices" class="choices">
            <!-- Keep existing Strap selection set from your current app (19 options) -->
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Extra Heavy" data-grade="1" data-selection="Extra Heavy 1"><span class="top">Extra Heavy</span><span class="bottom">1</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Extra Heavy" data-grade="2" data-selection="Extra Heavy 2"><span class="top">Extra Heavy</span><span class="bottom">2</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Extra Heavy" data-grade="3" data-selection="Extra Heavy 3"><span class="top">Extra Heavy</span><span class="bottom">3</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Extra Heavy" data-grade="4" data-selection="Extra Heavy 4"><span class="top">Extra Heavy</span><span class="bottom">4</span></button>

            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Heavy" data-grade="1" data-selection="Heavy 1"><span class="top">Heavy</span><span class="bottom">1</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Heavy" data-grade="2" data-selection="Heavy 2"><span class="top">Heavy</span><span class="bottom">2</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Heavy" data-grade="3" data-selection="Heavy 3"><span class="top">Heavy</span><span class="bottom">3</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Heavy" data-grade="4" data-selection="Heavy 4"><span class="top">Heavy</span><span class="bottom">4</span></button>

            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Med" data-grade="1" data-selection="Med 1"><span class="top">Med</span><span class="bottom">1</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Med" data-grade="2" data-selection="Med 2"><span class="top">Med</span><span class="bottom">2</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Med" data-grade="3" data-selection="Med 3"><span class="top">Med</span><span class="bottom">3</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Med" data-grade="4" data-selection="Med 4"><span class="top">Med</span><span class="bottom">4</span></button>

            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Light" data-grade="1" data-selection="Light 1"><span class="top">Light</span><span class="bottom">1</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Light" data-grade="2" data-selection="Light 2"><span class="top">Light</span><span class="bottom">2</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Light" data-grade="3" data-selection="Light 3"><span class="top">Light</span><span class="bottom">3</span></button>
            <button type="button" class="chip" onclick="selectSelection(this)" data-weight="Light" data-grade="4" data-selection="Light 4"><span class="top">Light</span><span class="bottom">4</span></button>

            <button type="button" class="chip single" onclick="selectSelection(this)" data-weight="Mose Heavy" data-grade="" data-selection="Mose Heavy">Mose Heavy</button>
            <button type="button" class="chip single" onclick="selectSelection(this)" data-weight="Mose Medium" data-grade="" data-selection="Mose Medium">Mose Medium</button>
            <button type="button" class="chip single" onclick="selectSelection(this)" data-weight="3X" data-grade="" data-selection="3X">3X</button>
          </div>
          <div class="hint" style="margin-top:6px">Select one selection to enable Submit.</div>
        </div>

        <div style="flex:1">
          <div class="section-title">Reason (optional)</div>
          <div id="reasonChoices" class="choices smallCols">
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Butcher Cut">Butcher Cut</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Folds">Folds</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Heavy Draw">Heavy Draw</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Insect Damage">Insect Damage</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Kidney Grease">Kidney Grease</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Machine Damage">Machine Damage</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Puller Damage">Puller Damage</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Purple Stain">Purple Stain</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="Scud">Scud</button>
            <button type="button" class="chip single" onclick="toggleReason(this)" data-value="White Streak">White Streak</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <button id="submitBtn" class="btn">Submit</button>
        <button id="undoBtn" class="btn secondary" title="Remove most recent entry">Undo last</button>
        <button id="clearBtn" class="btn danger" title="Delete ALL entries">Delete all</button>
      </div>
      <p class="hint" style="margin-top:8px">Submit keeps Packer & Lot for faster repeat logging; clears Selection and Reason.</p>
    </section>

    <section class="card" style="margin-top:16px">
      <h2 style="margin-top:0">Log</h2>
      <div style="overflow:auto">
        <table id="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Packer</th>
              <th>Sorted By</th>
              <th>Lot Number</th>
              <th>Selection</th>
              <th>Reason</th>
              <th>Timestamp</th>
              <th>Weight</th>
              <th>Grade</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
  // Inline handler functions so Safari/iPad executes without relying on addEventListener
  function selectSelection(btn){
    var chips = document.querySelectorAll('#selectionChoices .chip');
    for (var i=0;i<chips.length;i++){ chips[i].classList.remove('sel-selected'); }
    btn.classList.add('sel-selected');
  }
  function toggleReason(btn){
    var chips = document.querySelectorAll('#reasonChoices .chip');
    var wasOn = btn.classList.contains('reason-selected');
    for (var i=0;i<chips.length;i++){ chips[i].classList.remove('reason-selected'); }
    if(!wasOn){ btn.classList.add('reason-selected'); }
  }
</script>

<script>
(function(){
  const LS_KEY = 'strapSortingLog_local_light';
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }

  const selectionGroup = $('#selectionChoices');
  const reasonGroup = $('#reasonChoices');
  const tableBody = $('#table tbody');

  const packerEl = $('#packer');
  const sortedByEl = $('#sortedBy');
  const lotEl = $('#lot');

  const submitBtn = $('#submitBtn');
  const exportBtn = $('#exportBtn');
  const clearBtn = $('#clearBtn');
  const undoBtn = $('#undoBtn');

  function getSelectedSelection(){ return selectionGroup.querySelector('.chip.sel-selected'); }
  function getSelectedReason(){ const el = reasonGroup.querySelector('.chip.reason-selected'); return el ? el.getAttribute('data-value') : ''; }

  function readLog(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e) { return []; } }
  function writeLog(data){ try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch(e){} }

  function renderTable(){
    const data = readLog();
    tableBody.innerHTML = data.map((row, idx)=>{
      return '<tr>' +
        '<td>'+(idx+1)+'</td>' +
        '<td>'+escapeHtml(row.packer)+'</td>' +
        '<td>'+escapeHtml(row.sortedBy)+'</td>' +
        '<td>'+escapeHtml(row.lot)+'</td>' +
        '<td>'+escapeHtml(row.selection)+'</td>' +
        '<td>'+escapeHtml(row.reason)+'</td>' +
        '<td>'+fmtDateTime(row.ts)+'</td>' +
        '<td>'+escapeHtml(row.weight)+'</td>' +
        '<td>'+escapeHtml(row.grade)+'</td>' +
      '</tr>';
    }).join('');
  }

  function fmtDateTime(iso){ try { return new Date(iso).toLocaleString(); } catch(e){ return iso; } }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]); }); }

  renderTable();

  submitBtn.addEventListener('click', function(){
    const packer = (packerEl.value || '').trim();
    const sortedBy = (sortedByEl.value || '').trim();
    const lot = (lotEl.value || '').trim();
    const selBtn = getSelectedSelection();
    const reason = getSelectedReason();

    if(!packer){ alert('Please choose a Packer.'); return; }
    if(!/^[A-Za-z0-9]{1,6}$/.test(lot)){ alert('Lot Number must be 1â€“6 letters/numbers (e.g., 105 or 105CS).'); return; }
    if(!selBtn){ alert('Please choose one Selection.'); return; }

    const weight = selBtn.getAttribute('data-grade') ? selBtn.getAttribute('data-weight') : selBtn.getAttribute('data-selection');
    const grade = selBtn.getAttribute('data-grade') || '';
    const selectionText = selBtn.getAttribute('data-selection');

    const entry = { packer, sortedBy, lot, selection: selectionText, reason, ts: new Date().toISOString(), weight, grade };

    const data = readLog(); data.push(entry); writeLog(data);

    // clear selections
    $all('#selectionChoices .chip').forEach(function(b){ b.classList.remove('sel-selected'); });
    $all('#reasonChoices .chip').forEach(function(b){ b.classList.remove('reason-selected'); });

    renderTable();
  });

  undoBtn.addEventListener('click', function(){
    const data = readLog(); if(!data.length){ alert('No entries to undo.'); return; }
    if(!confirm('Undo last entry? This will delete the most recent entry.')) return;
    data.pop(); writeLog(data); renderTable();
  });

  clearBtn.addEventListener('click', function(){
    if(confirm('Delete ALL entries? This cannot be undone.')){ writeLog([]); renderTable(); }
  });

  exportBtn.addEventListener('click', function(){
    const data = readLog();
    const header = ['Packer','Sorted By','Lot Number','Selection','Reason','Timestamp','Weight','Grade'];
    const rows = data.map(function(r){ return [r.packer, r.sortedBy, r.lot, r.selection, r.reason, r.ts, r.weight, r.grade]; });
    const csv = [header].concat(rows).map(function(cols){
      return cols.map(function(v){
        var s = String(v == null ? '' : v);
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
      }).join(',');
    }).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const today = new Date().toISOString().slice(0,10);
    a.href = url; a.download = 'strap-sorting-log-' + today + '.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });
})();
</script>

<!-- No SW here; this single file is meant for local testing -->
</body>
</html>
